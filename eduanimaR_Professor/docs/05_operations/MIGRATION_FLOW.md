# MIGRATION_FLOW

## 目的
Atlas v1.0.0 による宣言的マイグレーションの運用手順を定義し、環境差分と人為ミスを防ぐ。

## 原則
- スキーマの正は `schema.hcl` のみ
- 手動で `ALTER TABLE` を発行しない
- 破壊的変更は原則禁止。必要なら expand/contract で段階化する
- マイグレーションは「アプリのロールバック可能性」とセットで設計する

## 変更の分類（運用上の目安）
- 低リスク: NULL可のカラム追加、インデックス追加（CONCURRENTLY等の方針はDB運用に従う）
- 中リスク: 制約追加、NOT NULL 化（事前の backfill を前提）
- 高リスク: カラム削除、型変更、大規模リライト（段階化 + メンテ窓/十分な検証が必要）

## 変更フロー（例）
1. `schema.hcl` を変更
2. 差分を確認（CIで plan 相当を実行）
3. レビュー（破壊的変更/ロック/実行時間/ロールバック互換を確認）
4. ステージングへ適用（アプリの互換コードが揃っていること）
5. 本番適用（メンテ窓/ロールバック方針を事前合意）

## Expand/Contract（必須）
破壊的変更を直接本番に出さない。

- Expand:
	- 新カラム追加（NULL可）
	- 新テーブル追加
- App rollout:
	- 新旧の読み書きを両対応（互換期間）
- Backfill:
	- バッチ/ワーカー等でデータを埋める
- Contract:
	- 制約強化（NOT NULL / FK など）
	- 旧カラム削除

> リリースと同期して進める（関連: `05_operations/RELEASE_DEPLOY.md` / `05_operations/PROGRESSIVE_DELIVERY.md`）。

## CI/CD での扱い（推奨）
- PR では plan を必須にして差分をレビュー可能にする
- apply は段階環境 → 本番の順に実施し、適用ログを保存する
- 失敗時に備え、マイグレーション実行者（ジョブ/人）とチケットを紐付ける

## 監視
- 失敗時は適用ログと差分を保存
- 変更履歴はチケット/PRに紐付ける

## 事故時の原則
- まず「書き込み停止/機能停止」で被害を抑える（必要なら feature flag で緩和）
- DB を“戻す”より、アプリのロールバック + 互換スキーマ維持で復旧する設計に寄せる
