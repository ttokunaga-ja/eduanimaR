openapi: 3.1.0
info:
  title: eduanima-professor API
  version: 1.0.0
  description: |
    Professor API (HTTP/JSON + SSE)

    ## 通信スタック
    - Frontend ↔ Professor: HTTP/JSON + SSE（永続）
    - Professor ↔ Librarian: gRPC双方向ストリーミング（Phase 1から）

    ## Phase 1: ローカル開発
    - 全リクエストで user_id='00000000-0000-0000-0000-000000000001' を固定使用
    - `X-Dev-User: dev-user` ヘッダーによる固定ユーザー識別
    - Phase 2でSSO認証実装時に /v1/auth/dev-login を削除し、Authorization: Bearer <token> に移行

    ## エンドポイント設計原則
    - リソースは名詞・複数形（subjects / materials / chats）
    - 階層ネスト: subjects 配下に materials・chats を配置
    - SSE: POST /v1/subjects/{id}/chats → Content-Type: text/event-stream で直接ストリーム

servers:
  - url: http://localhost:8080
    description: Local development

tags:
  - name: Auth
    description: Authentication endpoints (Phase 1 dev-only)
  - name: Subjects
    description: Subject management
  - name: Materials
    description: Material upload and management
  - name: Chats
    description: Q&A chat sessions with SSE streaming
  - name: Health
    description: Health check endpoints

paths:
  # ─────────────────────────────────────────
  # Auth
  # ─────────────────────────────────────────
  /v1/auth/dev-login:
    post:
      tags: [Auth]
      summary: Phase 1固定ユーザーログイン（開発用）
      description: |
        Phase 1のみ有効。固定のdev-userセッションを発行する。
        Phase 2でSSO認証に置き換え。本番環境では無効化必須。
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  example: "dev@example.com"
      responses:
        '200':
          description: ログイン成功
          content:
            application/json:
              schema:
                type: object
                required: [user_id, email]
                properties:
                  user_id:
                    type: string
                    format: uuid
                    example: "00000000-0000-0000-0000-000000000001"
                  email:
                    type: string
                    example: "dev@example.com"

  # ─────────────────────────────────────────
  # Subjects（科目）
  # ─────────────────────────────────────────
  /v1/subjects:
    get:
      tags: [Subjects]
      summary: 科目一覧取得
      description: |
        ユーザーの科目一覧を取得。
        拡張機能がLMSコースIDから subject_id を解決する際にも使用（?lms_course_id= クエリ）。
      parameters:
        - name: lms_course_id
          in: query
          required: false
          description: LMSコースIDで絞り込み（拡張機能のコース判別に使用）
          schema:
            type: string
      responses:
        '200':
          description: 科目リスト
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Subject'
    post:
      tags: [Subjects]
      summary: 科目作成
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  example: "データ構造とアルゴリズム"
                lms_course_id:
                  type: string
                  nullable: true
                  example: "12345"
      responses:
        '201':
          description: 科目作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subject'
        '400':
          $ref: '#/components/responses/BadRequest'

  /v1/subjects/{subject_id}:
    get:
      tags: [Subjects]
      summary: 科目詳細取得
      parameters:
        - $ref: '#/components/parameters/SubjectId'
      responses:
        '200':
          description: 科目詳細
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subject'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [Subjects]
      summary: 科目削除
      parameters:
        - $ref: '#/components/parameters/SubjectId'
      responses:
        '204':
          description: 削除成功
        '404':
          $ref: '#/components/responses/NotFound'

  # ─────────────────────────────────────────
  # Materials（資料）- subjects 配下にネスト
  # ─────────────────────────────────────────
  /v1/subjects/{subject_id}/materials:
    get:
      tags: [Materials]
      summary: 資料一覧取得
      description: |
        指定した科目の資料一覧を取得。
        Web版の「資料一覧」表示に使用。
      parameters:
        - $ref: '#/components/parameters/SubjectId'
        - name: status
          in: query
          required: false
          description: 処理状態でフィルタ
          schema:
            $ref: '#/components/schemas/MaterialStatus'
      responses:
        '200':
          description: 資料リスト
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Material'
        '404':
          $ref: '#/components/responses/NotFound'
    post:
      tags: [Materials]
      summary: 資料アップロード
      description: |
        ファイルをアップロードし、Kafka経由で非同期処理（OCR/Embedding）を開始。
        Phase 1: X-Dev-User ヘッダーによる固定ユーザー（認証スキップ）
        Phase 2以降: Bearer トークンによるSSO認証
        curlによる直接アップロード（ローカルテスト用）:
          curl -X POST http://localhost:8080/v1/subjects/{subject_id}/materials \
            -H "X-Dev-User: dev-user" \
            -F "file=@document.pdf"
      parameters:
        - $ref: '#/components/parameters/SubjectId'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '202':
          description: アップロード受付（Kafka非同期処理開始）
          content:
            application/json:
              schema:
                type: object
                required: [material_id, status]
                properties:
                  material_id:
                    type: string
                    format: uuid
                  status:
                    $ref: '#/components/schemas/MaterialStatus'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /v1/subjects/{subject_id}/materials/{material_id}:
    get:
      tags: [Materials]
      summary: 資料詳細・処理状態確認
      description: |
        アップロード後のKafka非同期処理状態をポーリングするために使用。
        status: pending → processing → ready | failed
      parameters:
        - $ref: '#/components/parameters/SubjectId'
        - $ref: '#/components/parameters/MaterialId'
      responses:
        '200':
          description: 資料詳細
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Material'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [Materials]
      summary: 資料削除
      parameters:
        - $ref: '#/components/parameters/SubjectId'
        - $ref: '#/components/parameters/MaterialId'
      responses:
        '204':
          description: 削除成功
        '404':
          $ref: '#/components/responses/NotFound'

  # ─────────────────────────────────────────
  # Chats（Q&Aセッション）- subjects 配下にネスト
  # ─────────────────────────────────────────
  /v1/subjects/{subject_id}/chats:
    post:
      tags: [Chats]
      summary: 質問送信（SSE ストリーミング）
      description: |
        質問を送信し、Server-Sent Events でリアルタイム応答を受信。
        内部では Professor が Librarian に gRPC 双方向ストリーミングで推論を委譲する。
        Phase 1: X-Dev-User ヘッダーによる固定ユーザー
        Phase 2以降: Bearer トークンによるSSO認証

        SSEイベント種別:
          thinking  → AI Agentが戦略立案中（プログレスバー表示用）
          searching → 資料を検索中（クエリ文字列を含む）
          evidence  → 根拠資料を選定完了（ファイル名・ページ・抜粋）
          chunk     → 回答テキスト断片（Markdown形式で逐次配信）
          done      → 完了（chat_idを含む）
          error     → エラー発生（再試行可能）
      parameters:
        - $ref: '#/components/parameters/SubjectId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [question]
              properties:
                question:
                  type: string
                  example: "決定係数の計算式を教えてください"
                parent_chat_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: ヒアリング判断で選択肢から選んだ場合、親チャットIDを指定
      responses:
        '200':
          description: SSEストリーミング開始
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  SSEフォーマット（各行は "data: {json}" 形式）
              examples:
                thinking:
                  summary: 戦略立案中
                  value: |
                    data: {"type":"thinking","content":"検索戦略を立案中..."}
                searching:
                  summary: 検索中
                  value: |
                    data: {"type":"searching","query":"決定係数 計算式"}
                evidence:
                  summary: 根拠資料選定
                  value: |
                    data: {"type":"evidence","material_id":"uuid","name":"lecture03.pdf","page":12,"excerpt":"決定係数 R² は..."}
                chunk:
                  summary: 回答テキスト断片
                  value: |
                    data: {"type":"chunk","content":"決定係数 R² の計算式は..."}
                done:
                  summary: 完了
                  value: |
                    data: {"type":"done","chat_id":"uuid"}
                error:
                  summary: エラー
                  value: |
                    data: {"type":"error","code":"SEARCH_TIMEOUT","request_id":"uuid"}
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
    get:
      tags: [Chats]
      summary: 会話履歴一覧取得
      description: |
        指定した科目の会話履歴一覧を取得。
        Web版の「会話履歴」表示に使用。
      parameters:
        - $ref: '#/components/parameters/SubjectId'
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: cursor
          in: query
          required: false
          description: カーソルベースページネーション
          schema:
            type: string
      responses:
        '200':
          description: 会話履歴リスト
          content:
            application/json:
              schema:
                type: object
                required: [chats]
                properties:
                  chats:
                    type: array
                    items:
                      $ref: '#/components/schemas/ChatSummary'
                  next_cursor:
                    type: string
                    nullable: true
        '404':
          $ref: '#/components/responses/NotFound'

  /v1/subjects/{subject_id}/chats/{chat_id}:
    get:
      tags: [Chats]
      summary: 会話詳細取得
      parameters:
        - $ref: '#/components/parameters/SubjectId'
        - $ref: '#/components/parameters/ChatId'
      responses:
        '200':
          description: 会話詳細
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatDetail'
        '404':
          $ref: '#/components/responses/NotFound'

  /v1/subjects/{subject_id}/chats/{chat_id}/feedback:
    post:
      tags: [Chats]
      summary: フィードバック送信（Good/Bad）
      description: |
        回答末尾のGood/Badボタンによるフィードバックを送信。
        研究目的の学習効果測定に使用。
      parameters:
        - $ref: '#/components/parameters/SubjectId'
        - $ref: '#/components/parameters/ChatId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [rating]
              properties:
                rating:
                  type: string
                  enum: [good, bad]
                  example: "good"
                comment:
                  type: string
                  nullable: true
                  example: "根拠が明確で分かりやすかった"
      responses:
        '204':
          description: フィードバック受付
        '404':
          $ref: '#/components/responses/NotFound'

  # ─────────────────────────────────────────
  # Health
  # ─────────────────────────────────────────
  /healthz:
    get:
      tags: [Health]
      summary: Liveness check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"

  /readyz:
    get:
      tags: [Health]
      summary: Readiness check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ready"

# ─────────────────────────────────────────
# Components
# ─────────────────────────────────────────
components:
  parameters:
    SubjectId:
      name: subject_id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    MaterialId:
      name: material_id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    ChatId:
      name: chat_id
      in: path
      required: true
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Not Found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    MaterialStatus:
      type: string
      enum: [pending, processing, ready, failed]
      description: |
        pending   → アップロード受付、Kafkaキュー待ち
        processing → OCR/Embedding処理中
        ready     → 検索可能
        failed    → 処理失敗（error_messageを参照）

    Subject:
      type: object
      required: [subject_id, name, created_at]
      properties:
        subject_id:
          type: string
          format: uuid
        name:
          type: string
          example: "データ構造とアルゴリズム"
        lms_course_id:
          type: string
          nullable: true
          example: "12345"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Material:
      type: object
      required: [material_id, subject_id, name, status, uploaded_at]
      properties:
        material_id:
          type: string
          format: uuid
        subject_id:
          type: string
          format: uuid
        name:
          type: string
          example: "lecture01.pdf"
        status:
          $ref: '#/components/schemas/MaterialStatus'
        error_message:
          type: string
          nullable: true
          description: status=failed 時のエラー詳細
        uploaded_at:
          type: string
          format: date-time
        processed_at:
          type: string
          format: date-time
          nullable: true

    ChatSummary:
      type: object
      required: [chat_id, subject_id, question, created_at]
      properties:
        chat_id:
          type: string
          format: uuid
        subject_id:
          type: string
          format: uuid
        question:
          type: string
          example: "決定係数の計算式を教えてください"
        answered_at:
          type: string
          format: date-time
          nullable: true
          description: null の場合は未完了（タイムアウト/エラー）
        created_at:
          type: string
          format: date-time

    ChatDetail:
      type: object
      required: [chat_id, subject_id, question, created_at]
      properties:
        chat_id:
          type: string
          format: uuid
        subject_id:
          type: string
          format: uuid
        question:
          type: string
        answer:
          type: string
          nullable: true
          description: 最終回答テキスト（SSE完了後に保存）
        sources:
          type: array
          nullable: true
          description: 参照した資料の一覧
          items:
            type: object
            required: [material_id, name]
            properties:
              material_id:
                type: string
                format: uuid
              name:
                type: string
              page:
                type: integer
                nullable: true
              excerpt:
                type: string
        feedback:
          type: string
          enum: [good, bad]
          nullable: true
        parent_chat_id:
          type: string
          format: uuid
          nullable: true
          description: ヒアリング判断による選択肢選択の親チャット
        answered_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message, request_id]
          properties:
            code:
              type: string
              description: アプリケーションエラーコード（docs/03_integration/ERROR_CODES.md 参照）
              example: "VALIDATION_FAILED"
            message:
              type: string
              description: ユーザー向けメッセージ（内部詳細・Secretsを含まない）
              example: "Validation failed"
            details:
              type: object
              additionalProperties: true
            request_id:
              type: string
              format: uuid
