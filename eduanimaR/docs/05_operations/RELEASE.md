# Release & Environments（環境/リリース/ロールバック）

Last-updated: 2026-02-15

このドキュメントは、環境差分とリリース手順を固定し、
「本番だけ壊れる」「戻せない」を防ぐための運用契約です。

---

## 結論（Must）

- 環境差分は `.env` とドキュメントに集約（コード内ハードコード禁止）

テンプレのデフォルト：
- `.env.example` をベースに `.env.local`（local）/ プラットフォームの環境変数（staging/production）へ反映する
- リリースは “戻せる” こと（ロールバック手順）を前提に設計する
- DB/API の互換性を考慮し、段階的リリースを可能にする（Feature Flag など）

---

## 環境一覧（プロジェクト固有で埋める）

- local
- staging
- production

各環境での差分：
- API base URL
- 認証方式（Cookie/Bearer）
- 外部連携（Analytics / Error reporting）

---

## 事前確認（Must）

- `next build` が通る
- 主要ページの SSR/Hydration が崩れていない（初期表示/操作）
- 主要 mutation 後の整合（キャッシュ無効化）が正しい

---

## ロールバック

- ロールバック条件（SLO 逸脱、致命バグ、決済影響など）を明文化
- DB マイグレーションが絡む場合は、
  - 後方互換
  - 二段階デプロイ
  - もしくは “戻せない” ことの合意
を必ず行う

## Phase 1-4のスコープ明記（Must）

### Phase別のリリーススコープ

- **Phase 1**: ローカル開発（認証スキップ）
  - 基本的なQ&A機能、資料管理
  - Professorとの基本連携
  
- **Phase 2**: SSO認証実装、Web版・拡張機能同時リリース
  - Google/Meta/Microsoft/LINE認証
  - 本番環境デプロイ
  
- **Phase 3-4**: 段階的な機能追加
  - Librarian推論ループ連携、高度な検索（Phase 3）
  - 学習計画、進捗管理（Phase 4）
  - **注意**: グループ共有は含まない

### リリース可否の判断基準（Must）

以下の基準をすべて満たすことをリリース条件とする:

- **SLO基準**: Core Web Vitals、エラー率、レイテンシが目標値内
- **契約テスト**: `contract-codegen-check` が成功
- **セキュリティスキャン**: 依存関係の脆弱性なし、シークレット漏洩なし
- **E2Eテスト**: 主要導線が正常動作

**参照元SSOT**:
- `../../eduanimaRHandbook/04_product/ROADMAP.md`
- `../../eduanimaR_Professor/docs/05_operations/RELEASE_DEPLOY.md`

---

## 本番環境での禁止事項（Must）

### Web版での機能制限
- **新規ユーザー登録**: 禁止。拡張機能のSSO認証からのみ登録可能。
- **科目登録**: 禁止。拡張機能での履修科目自動同期のみ。
- **ファイルアップロード**: 禁止。拡張機能での自動アップロードのみ。

### フロントエンドの責務範囲
- フロントエンドはファイルアップロードUIを持たない
- フロントエンドは開発専用の認証UIを持たない
- 開発環境でのファイルアップロードは外部ツール（curl, Postman等）でProfessor APIへ直接実行
- 開発環境での認証はProfessor側のdev-user自動設定で対応

### デプロイチェックリスト
- **本番・開発環境共通**:
  - [ ] フロントエンドにファイルアップロード機能が存在しないこと
  - [ ] フロントエンドに開発専用認証UI（メール認証等）が存在しないこと
  - [ ] 拡張機能のSSO認証エンドポイントが有効
