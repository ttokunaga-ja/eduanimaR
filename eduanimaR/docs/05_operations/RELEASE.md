# Release & Environments（環境/リリース/ロールバック）

Last-updated: 2026-02-15

このドキュメントは、環境差分とリリース手順を固定し、
「本番だけ壊れる」「戻せない」を防ぐための運用契約です。

---

## 結論（Must）

- 環境差分は `.env` とドキュメントに集約（コード内ハードコード禁止）

テンプレのデフォルト：
- `.env.example` をベースに `.env.local`（local）/ プラットフォームの環境変数（staging/production）へ反映する
- リリースは “戻せる” こと（ロールバック手順）を前提に設計する
- DB/API の互換性を考慮し、段階的リリースを可能にする（Feature Flag など）

---

## 環境一覧（プロジェクト固有で埋める）

- local
- staging
- production

各環境での差分：
- API base URL
- 認証方式（Cookie/Bearer）
- 外部連携（Analytics / Error reporting）

---

## 事前確認（Must）

- `next build` が通る
- 主要ページの SSR/Hydration が崩れていない（初期表示/操作）
- 主要 mutation 後の整合（キャッシュ無効化）が正しい

---

## ロールバック

- ロールバック条件（SLO 逸脱、致命バグ、決済影響など）を明文化
- DB マイグレーションが絡む場合は、
  - 後方互換
  - 二段階デプロイ
  - もしくは “戻せない” ことの合意
を必ず行う

## Phase 1-5のリリーススコープ（完全版定義）

### Phase 1: バックエンド完成 + Web版完全動作（ローカル開発）

**リリース範囲**: ローカル環境のみ

**実装完了条件**:
- Professor APIが完全に動作（OpenAPI定義完備）
- Librarian推論ループとの統合完了（gRPC双方向ストリーミング）
- 認証不要でcurlリクエストによる資料アップロードが可能（開発用エンドポイント）
- Web版固有機能すべてが使用可能（資料一覧・会話履歴・科目選択UI）
- QA機能が完全に動作（プログレスバー・フィードバックボタン・お問い合わせフォーム）
- 拡張機能実装（ローカル読み込みで動作確認）

**配布方法**: なし（開発環境のみ）

**検証項目**:
- 検索成功率70%以上（10件の検証質問）
- 検索応答時間p95で5秒以内
- ハルシネーション率20%以下
- 5名以上の被験者から肯定的評価

---

### Phase 2: 拡張機能版作成 + 本番環境デプロイ

**リリース範囲**: 本番環境 + ZIPファイル配布

**実装完了条件**:
- 拡張機能版をZIPファイルで動作可能にする（Chrome Web Store公開はPhase 3）
- SSO認証実装（Google/Meta/Microsoft/LINE）
- Web版: 新規登録UI禁止、未登録ユーザーへの拡張機能ダウンロード誘導UI
- バックエンド: 本番環境デプロイ（Google Cloud Run）

**配布方法**:
- 拡張機能: ZIPファイル（限定配布）
- Web版: 本番デプロイ（一般公開、拡張機能ユーザーのみログイン可）

**デプロイ手順**:
1. Professor バックエンドをCloud Runへデプロイ
2. Web版をVercel/Cloud Run等へデプロイ
3. 拡張機能ZIPファイルを生成・配布
4. SSO認証の動作確認
5. 未登録ユーザーの拡張機能誘導フローを確認

---

### Phase 3: Chrome Web Store公開

**リリース範囲**: Chrome Web Store

**実装完了条件**:
- Chrome Web Storeで公開（非公開配布 or 限定公開）
- ストア審査対応（プライバシーポリシー・スクリーンショット等）

**配布方法**:
- 拡張機能: Chrome Web Store
- Web版・バックエンド: Phase 2から変更なし

**デプロイ手順**:
1. Chrome Web Store Developer Dashboardで申請
2. 審査対応（プライバシーポリシー・スクリーンショット・説明文等）
3. 公開承認後、限定公開または非公開配布で運用開始

---

### Phase 4: 閲覧中画面の解説機能追加

**リリース範囲**: 拡張機能・バックエンドの機能追加

**実装完了条件**:
- 拡張機能: 現在閲覧中の画面のHTML・画像取得機能
- バックエンド: HTML・画像を受け取るエンドポイント追加、Gemini Vision API統合

**デプロイ手順**:
1. Professor バックエンドへエンドポイント追加・デプロイ
2. 拡張機能へHTML・画像取得機能追加
3. Chrome Web Storeへ更新版を申請

---

### Phase 5: 学習計画立案機能（構想段階）

**リリース範囲**: 未定（構想段階）

**備考**:
- Phase 1-4の完了後に詳細を検討
- 小テスト結果の保存方式（短期/長期）
- 学習履歴の匿名化
- プライバシー配慮（被験者データの扱い）

---

### リリース可否の判断基準（Must）

以下の基準をすべて満たすことをリリース条件とする:

- **SLO基準**: Core Web Vitals、エラー率、レイテンシが目標値内
- **契約テスト**: `contract-codegen-check` が成功
- **セキュリティスキャン**: 依存関係の脆弱性なし、シークレット漏洩なし
- **E2Eテスト**: 主要導線が正常動作

**参照元SSOT**:
- `../../eduanimaRHandbook/04_product/ROADMAP.md`
- `../../eduanimaR_Professor/docs/05_operations/RELEASE_DEPLOY.md`

---

## 本番環境での禁止事項（Must）

### Web版での機能制限
- **新規ユーザー登録**: 禁止。拡張機能のSSO認証からのみ登録可能。
- **科目登録**: 禁止。拡張機能での履修科目自動同期のみ。
- **ファイルアップロード**: 禁止。拡張機能での自動アップロードのみ。

### フロントエンドの責務範囲
- フロントエンドはファイルアップロードUIを持たない
- フロントエンドは開発専用の認証UIを持たない
- 開発環境でのファイルアップロードは外部ツール（curl, Postman等）でProfessor APIへ直接実行
- 開発環境での認証はProfessor側のdev-user自動設定で対応

### デプロイチェックリスト
- **本番・開発環境共通**:
  - [ ] フロントエンドにファイルアップロード機能が存在しないこと
  - [ ] フロントエンドに開発専用認証UI（メール認証等）が存在しないこと
  - [ ] 拡張機能のSSO認証エンドポイントが有効
