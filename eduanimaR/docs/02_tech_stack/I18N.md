# i18n Policy（next-intl / Next.js App Router）

このドキュメントは、next-intl を用いた国際化（i18n）の方針を固定し、将来の多言語化に備えた実装指針を契約化します。

関連：
- ルーティング：`ROUTING_UX_CONVENTIONS.md`
- i18n/Locale：`../03_integration/I18N_LOCALE.md`
- コンポーネント：`../01_architecture/COMPONENT_ARCHITECTURE.md`

---

## 結論（Must）

- ライブラリ: **next-intl**（Next.js App Router 完全対応）
- Phase 1 は **日本語のみ** だが、すべての UI 文言を翻訳キー（変数）として管理する
- **UI文言のハードコーディングを禁止**：必ず `messages/{locale}/*.json` から読み出す
- キー管理規約：ネームスペース形式（`{slice}.{component}.{key}`）
- CI/CD で翻訳漏れを検知する（`i18n:check` スクリプト）

---

## 1) ライブラリ選定理由

### 1.1 next-intl を選ぶ理由

- Next.js App Router（RSC / Server Components）に完全対応
- ルーティング統合が容易（`[locale]` パラメータによる自動切替）
- TypeScript サポートが強力（キーの型安全性）
- SSR / SSG でのパフォーマンスが良い

他の候補（react-i18next / i18next）は Client Components 中心のため、今回は採用しない。

---

## 2) Phase 1: 日本語のみだが変数化は必須

### 2.1 方針

Phase 1 では **日本語のみ** を提供するが、すべての UI 文言を翻訳キーとして管理する。

理由：
- Phase 2 以降で英語・中国語等の多言語対応を予定
- 後から「ハードコードされた文言」を探し出して置き換えるのは困難
- 最初から変数化することで、多言語化時の作業を最小化

### 2.2 実装例

❌ **禁止例**（ハードコード）：
```tsx
export function SubjectSelector() {
  return (
    <Select>
      <option>科目を選択してください</option>
      {/* ... */}
    </Select>
  );
}
```

✅ **推奨例**（翻訳キー）：
```tsx
import { useTranslations } from 'next-intl';

export function SubjectSelector() {
  const t = useTranslations('features.subjectSelector');
  
  return (
    <Select>
      <option>{t('placeholder')}</option>
      {/* ... */}
    </Select>
  );
}
```

対応する翻訳ファイル（`messages/ja/features.json`）：
```json
{
  "subjectSelector": {
    "placeholder": "科目を選択してください"
  }
}
```

---

## 3) ディレクトリ構成

```
messages/
  ja/
    common.json      # 共通文言（ボタン、エラーメッセージ等）
    pages.json       # ページ固有の文言
    features.json    # Features層の文言
    entities.json    # Entities層の文言
    errors.json      # エラーメッセージ
  en/              # Phase 2 以降
    common.json
    pages.json
    features.json
    entities.json
    errors.json
```

---

## 4) キー管理規約

### 4.1 ネームスペース形式

翻訳キーは以下の形式で管理する：

```
{slice}.{component}.{key}
```

例：
- `features.subjectSelector.placeholder`
- `pages.chatWorkspace.title`
- `entities.subject.name`
- `common.buttons.submit`
- `errors.network.connectionFailed`

### 4.2 共通文言の管理

頻出する文言（ボタン、エラーメッセージ等）は `common.json` に集約する：

```json
{
  "buttons": {
    "submit": "送信",
    "cancel": "キャンセル",
    "save": "保存",
    "delete": "削除",
    "close": "閉じる"
  },
  "labels": {
    "loading": "読み込み中...",
    "required": "必須",
    "optional": "任意"
  }
}
```

---

## 5) ルーティング統合（将来対応）

Phase 2 以降で多言語化する際のルーティング設計：

### 5.1 URL パス形式

```
/ja/app           # 日本語
/en/app           # 英語
/zh-CN/app        # 中国語（簡体字）
```

### 5.2 ロケール検出

以下の優先順位でロケールを決定：
1. URL パラメータ（`/ja/...`）
2. Cookie（`NEXT_LOCALE`）
3. Accept-Language ヘッダー
4. デフォルト（`ja`）

### 5.3 next-intl の設定（Phase 2）

```typescript
// next.config.mjs (Phase 2)
import createNextIntlPlugin from 'next-intl/plugin';

const withNextIntl = createNextIntlPlugin();

export default withNextIntl({
  // ... 他の設定
});
```

```typescript
// i18n.ts (Phase 2)
import { notFound } from 'next/navigation';
import { getRequestConfig } from 'next-intl/server';

const locales = ['ja', 'en', 'zh-CN'] as const;

export default getRequestConfig(async ({ locale }) => {
  if (!locales.includes(locale as any)) notFound();

  return {
    messages: (await import(`./messages/${locale}/common.json`)).default,
  };
});
```

---

## 6) サーバーコンポーネントでの使用

next-intl は RSC（React Server Components）に完全対応している。

```tsx
// app/[locale]/page.tsx
import { useTranslations } from 'next-intl';

export default function HomePage() {
  const t = useTranslations('pages.home');
  
  return (
    <div>
      <h1>{t('title')}</h1>
      <p>{t('description')}</p>
    </div>
  );
}
```

---

## 7) パラメータ挿入

動的な値を翻訳に挿入する場合：

```json
{
  "greeting": "こんにちは、{name}さん",
  "fileCount": "{count}件のファイル"
}
```

```tsx
const t = useTranslations('common');

return (
  <div>
    <p>{t('greeting', { name: user.display_name })}</p>
    <p>{t('fileCount', { count: files.length })}</p>
  </div>
);
```

---

## 8) CI/CD での翻訳漏れ検知

### 8.1 スクリプト実装

`scripts/i18n-check.js` で、未翻訳キーや使用されていないキーを検出する。

```javascript
// scripts/i18n-check.js
const fs = require('fs');
const path = require('path');

function checkTranslations() {
  const jaMessages = require('../messages/ja/common.json');
  // ソースコードから翻訳キーを抽出
  // 未翻訳キーをレポート
  // ...
}

checkTranslations();
```

### 8.2 CI での実行

```yaml
# .github/workflows/ci.yml
- name: Check translations
  run: npm run i18n:check
```

---

## 9) 日付・数値フォーマット

ロケールに応じた日付・数値フォーマットは `Intl` API を使用する。

### 9.1 日付フォーマット

```typescript
// shared/lib/formatDate.ts
export function formatDate(date: Date, locale: string = 'ja-JP'): string {
  return new Intl.DateTimeFormat(locale, {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
}
```

### 9.2 数値フォーマット

```typescript
// shared/lib/formatNumber.ts
export function formatNumber(num: number, locale: string = 'ja-JP'): string {
  return new Intl.NumberFormat(locale).format(num);
}
```

---

## 10) メタデータの翻訳

ページタイトルやメタディスクリプションも翻訳する。

```tsx
// app/[locale]/layout.tsx
import { useTranslations } from 'next-intl';

export function generateMetadata({ params: { locale } }) {
  const t = useTranslations('metadata');
  
  return {
    title: t('title'),
    description: t('description'),
  };
}
```

---

## 禁止（AI/人間共通）

- **UI文言をハードコーディングする**（日本語のみの Phase 1 でも禁止）
- 翻訳キーを適当な名前で作成する（規約に従わない）
- 翻訳ファイルを手編集してフォーマットを崩す（JSON 構文エラー）
- ロケールが増えたときに一括置換できない構造にする
- 日付/数値フォーマットをページごとに散らす（`shared/lib` に集約）

---

## 実装チェックリスト

- [ ] すべての UI 文言が翻訳キー（変数）として管理されているか？
- [ ] ハードコードされた日本語文言が残っていないか？
- [ ] 翻訳キーがネームスペース規約に従っているか？
- [ ] `messages/ja/` に必要な JSON ファイルが配置されているか？
- [ ] CI で `i18n:check` が実行されているか？
- [ ] 日付/数値フォーマットが `shared/lib` に集約されているか？
- [ ] メタデータ（タイトル、説明）も翻訳されているか？
- [ ] パラメータ挿入が必要な箇所で適切に実装されているか？
