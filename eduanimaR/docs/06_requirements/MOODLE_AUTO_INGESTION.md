# Moodle資料自動取り込み仕様（Auto-Ingestion）

## 概要
eduanimaRの最重要機能であるMoodle資料の自動検知・アップロード機能の詳細仕様。

## 目的
- 学生の手動操作を完全に排除
- LMS上の資料を自動的に学習し、即座に質問可能な状態にする

## 技術的アプローチ

### 1. 資料検知
- Content ScriptによるMoodleページのDOM解析
- `mod/resource/view.php?id=XXXX` パターンの検出
- 既知の資料IDとの差分チェック（chrome.storage.local）

実装方針:
- MutationObserverを使用してDOM変更を監視
- 新しく追加された資料リンクを検知
- 既に収集済みの資料を重複して処理しないよう、IDをローカルストレージで管理

### 2. 自動ダウンロード
- ブラウザの認証セッションを利用
- fetch APIでBlob取得
- ファイルサイズ制限（50MB）

実装方針:
- ユーザーのLMSセッションを利用して資料をダウンロード
- 大容量ファイルのダウンロードは警告を表示
- ダウンロード失敗時のリトライ機構（最大3回、指数バックオフ）

### 3. バックエンド送信
- 拡張機能専用エンドポイント: POST /v1/resources/upload
- 拡張機能専用ヘッダー: X-Extension-Auth
- メタデータ: courseId, resourceName, fileType

リクエスト形式:
```
POST /v1/resources/upload
Authorization: Bearer <JWT>
X-Extension-Auth: <extension-key>
Content-Type: multipart/form-data

file: <binary-data>
subject_id: <course-id>
resource_name: <filename>
file_type: <pdf|pptx|docx|...>
source_url: <moodle-resource-url>
detected_at: <iso-timestamp>
```

レスポンス:
```
202 Accepted
{
  "resource_id": "uuid",
  "status": "processing"
}
```

### 4. RAGパイプライン
- PDF→テキスト変換
- チャンキング
- ベクトル化（OpenAI Embeddings）
- Pineconeに保存

バックエンド処理フロー:
1. アップロードされたファイルをS3/GCSに保存
2. Kafka経由で解析ワーカーにイベント送信
3. ワーカーがPDF/PPTXをテキストに変換
4. テキストをチャンク分割（1000トークン、200トークンオーバーラップ）
5. OpenAI Embeddings APIでベクトル化
6. Pineconeにメタデータ付きで保存
7. ユーザーに処理完了通知（拡張機能で表示）

## セキュリティ

### 認証・認可
- LMSドメイン制限（manifest.json）
- 拡張機能専用認証キー（X-Extension-Auth ヘッダー）
- ユーザーの履修科目のみ対象

### アクセス制御
- 各ユーザーは自分がアップロードした資料のみアクセス可能
- 科目IDによる厳格な検索範囲の制限
- 拡張機能専用エンドポイントはWebクライアントからアクセス不可

### データ保護
- アップロードされた資料は暗号化して保存
- ユーザー削除時に関連資料も完全削除
- ベクトルDBに保存されるメタデータには個人情報を含めない

## プライバシー

### データ収集範囲
- 自動収集される資料は、当該ユーザーのみアクセス可能
- ユーザーが履修している科目の資料のみを対象
- 他のユーザーの資料は一切収集しない

### ユーザーコントロール
- 拡張機能の設定で自動収集のON/OFF切り替え可能
- 個別の資料について自動収集の除外設定可能
- 収集済み資料の削除機能

### 透明性
- どの資料が収集されたかを拡張機能で一覧表示
- 各資料の処理状況（処理中/完了/エラー）を表示
- プライバシーポリシーへのリンクを常時表示

## ユーザー体験

### 初回セットアップ
1. 拡張機能をインストール
2. LMS上でSSO認証
3. 履修科目が自動同期
4. 過去の講義資料が自動検知され、一覧表示
5. ユーザーが承認後、自動アップロード開始

### 日常的な利用
1. LMSで新しい資料が公開される
2. 拡張機能が自動検知（バックグラウンド）
3. 自動的にダウンロード・アップロード
4. 処理完了後、通知（オプション）
5. すぐに質問可能な状態に

### エラーハンドリング
- ネットワークエラー: 自動リトライ（最大3回）
- ファイルサイズ超過: 警告表示、手動処理を促す
- アクセス権限エラー: ユーザーに再ログインを促す
- 処理失敗: エラー詳細を表示、サポートへの連絡導線

## パフォーマンス

### 効率化
- MutationObserverのdebounce（100ms）
- 同時アップロード制限（最大3ファイル）
- バックグラウンドでの非同期処理
- ユーザーのLMS閲覧を妨げない

### 負荷分散
- アップロードは時間帯を分散（深夜優先）
- 大量の資料がある場合は段階的に処理
- サーバー側のレート制限に対応

## モニタリング・メトリクス

### 成功指標
- 自動検知成功率（検知された資料数 / 実際の資料数）
- アップロード成功率
- 平均処理時間（検知→質問可能まで）
- ユーザー満足度（アンケート）

### エラー追跡
- 検知失敗の原因（DOM構造変更等）
- アップロード失敗の原因（ネットワーク/認証/サイズ等）
- 処理失敗の原因（変換エラー等）

## 将来の拡張

### 対応LMSの拡大
- 現在: Moodle
- 将来: Canvas, Blackboard, Google Classroom等

### 対応ファイル形式の拡大
- 現在: PDF, PPTX, DOCX
- 将来: 動画（音声文字起こし）、画像（OCR）、HTML等

### インテリジェントな優先順位付け
- 試験日が近い科目の資料を優先処理
- 頻繁に参照される資料を優先キャッシュ
- ユーザーの学習パターンに基づく最適化

## 関連ドキュメント
- `CHROME_EXTENSION_BACKEND_INTEGRATION.md` - バックエンド統合仕様
- `../../eduanimaRHandbook/01_philosophy/PRIVACY_POLICY.md` - プライバシーポリシー
- `../../eduanimaRHandbook/04_product/ROADMAP.md` - 製品ロードマップ
