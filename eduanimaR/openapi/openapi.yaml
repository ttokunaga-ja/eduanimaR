openapi: 3.1.0
info:
  title: eduanima-professor API
  version: 1.0.0
  description: |
    Professor API (HTTP/JSON + SSE)
    Phase 1: ローカル開発用API(認証スキップ)
    - 全リクエストで user_id='00000000-0000-0000-0000-000000000001' を固定使用
    - Phase 2でSSO認証実装時に /v1/auth/dev-login を削除
    - Authorization: Bearer <token> ヘッダー検証に移行

servers:
  - url: http://localhost:8080
    description: Local development

tags:
  - name: Auth
    description: Authentication endpoints (Phase 1 dev-only)
  - name: Questions
    description: Q&A and SSE streaming
  - name: Subjects
    description: Subject management
  - name: Materials
    description: Material upload and management
  - name: Health
    description: Health check endpoints

paths:
  /v1/auth/dev-login:
    post:
      tags: [Auth]
      summary: Phase 1固定ユーザーログイン(開発用)
      description: |
        Phase 1のみ有効。固定のdev-userを発行する。
        Phase 2でSSO認証に置き換え。
        本番環境では無効化必須。
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  example: "dev@example.com"
      responses:
        '200':
          description: ログイン成功
          content:
            application/json:
              schema:
                type: object
                required:
                  - user_id
                  - email
                properties:
                  user_id:
                    type: string
                    format: uuid
                    example: "00000000-0000-0000-0000-000000000001"
                  email:
                    type: string
                    example: "dev@example.com"

  /v1/subjects:
    get:
      tags: [Subjects]
      summary: 科目一覧取得
      description: |
        ユーザーの科目一覧を取得。
        Phase 1: user_id固定
      responses:
        '200':
          description: 科目リスト
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Subject'
    post:
      tags: [Subjects]
      summary: 科目作成
      description: |
        新しい科目を作成。
        Phase 1: user_id固定
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  example: "データ構造とアルゴリズム"
                lms_course_id:
                  type: string
                  nullable: true
                  example: "12345"
      responses:
        '201':
          description: 科目作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subject'

  /v1/subjects/{subject_id}/materials:
    get:
      tags: [Materials]
      summary: 科目の資料一覧取得
      description: |
        指定した科目の資料一覧を取得。
        Phase 1: user_id固定
      parameters:
        - name: subject_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 資料リスト
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Material'

  /v1/files:
    post:
      tags: [Materials]
      summary: ファイルアップロード
      description: |
        ファイルをアップロードし、非同期処理を開始。
        Phase 1: user_id固定
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - subject_id
                - file
              properties:
                subject_id:
                  type: string
                  format: uuid
                file:
                  type: string
                  format: binary
      responses:
        '202':
          description: アップロード受付(非同期処理開始)
          content:
            application/json:
              schema:
                type: object
                required:
                  - file_id
                  - status
                properties:
                  file_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    example: "pending"
                    enum: [pending, processing, ready, failed]

  /v1/qa/stream:
    post:
      tags: [Questions]
      summary: 質問応答(SSE)
      description: |
        質問を送信し、Server-Sent Eventsでストリーミング応答を受信。
        Phase 1: user_id固定
        Phase 2以降: SSO認証必須
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - subject_id
                - question
              properties:
                subject_id:
                  type: string
                  format: uuid
                  example: "12345678-1234-1234-1234-123456789012"
                question:
                  type: string
                  example: "次回の試験範囲は？"
      responses:
        '200':
          description: SSEストリーミング開始
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  SSEフォーマット:
                  data: {"type":"chunk","content":"テキスト断片"}
                  data: {"type":"source","file_id":"uuid","page":12,"excerpt":"引用"}
                  data: {"type":"done"}
              examples:
                chunk:
                  summary: テキスト断片
                  value: |
                    data: {"type":"chunk","content":"試験範囲は第3章から第5章までです。"}
                source:
                  summary: 参照元
                  value: |
                    data: {"type":"source","file_id":"12345678-1234-1234-1234-123456789012","page":12,"excerpt":"第3章: データ構造"}
                done:
                  summary: 完了
                  value: |
                    data: {"type":"done"}

  /healthz:
    get:
      tags: [Health]
      summary: Liveness check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
  /readyz:
    get:
      tags: [Health]
      summary: Readiness check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ready"

components:
  schemas:
    Subject:
      type: object
      required:
        - subject_id
        - name
        - created_at
      properties:
        subject_id:
          type: string
          format: uuid
          example: "12345678-1234-1234-1234-123456789012"
        name:
          type: string
          example: "データ構造とアルゴリズム"
        lms_course_id:
          type: string
          nullable: true
          example: "12345"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Material:
      type: object
      required:
        - file_id
        - name
        - status
        - uploaded_at
      properties:
        file_id:
          type: string
          format: uuid
          example: "87654321-4321-4321-4321-210987654321"
        name:
          type: string
          example: "lecture01.pdf"
        status:
          type: string
          enum: [pending, processing, ready, failed]
          example: "ready"
        uploaded_at:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message, request_id]
          properties:
            code:
              type: string
              description: Stable application error code (see docs/03_integration/ERROR_CODES.md)
              example: "VALIDATION_FAILED"
            message:
              type: string
              description: User-facing message (no secrets / no internal details)
              example: "Validation failed"
            details:
              type: object
              additionalProperties: true
            request_id:
              type: string
              format: uuid
