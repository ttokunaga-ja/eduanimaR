# docker-compose.yml
# Phase 1: ローカル開発環境（Docker Compose完結）
#
# 起動方法:
#   インフラのみ（開発中）:
#     docker compose up postgres kafka minio kafka-init minio-init
#   全サービス（アプリ含む）:
#     docker compose --profile app up
#
# 前提: .env.example を .env にコピーして GEMINI_API_KEY を設定すること

services:
  # ─────────────────────────────────────────
  # PostgreSQL 18 + pgvector 0.8.x
  # ─────────────────────────────────────────
  postgres:
    image: pgvector/pgvector:pg18
    container_name: eduanima_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-eduanima}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-eduanima_password}
      POSTGRES_DB: ${POSTGRES_DB:-eduanima_professor}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-eduanima} -d ${POSTGRES_DB:-eduanima_professor}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ─────────────────────────────────────────
  # Apache Kafka 3.9 (KRaft mode / Zookeeper不要)
  # ─────────────────────────────────────────
  kafka:
    image: bitnami/kafka:3.9
    container_name: eduanima_kafka
    restart: unless-stopped
    environment:
      # KRaft モード設定
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093
      # リスナー設定（PLAINTEXT: 内部通信 / EXTERNAL: ホストからのアクセス）
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      # トピック設定
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=false
      - KAFKA_CFG_NUM_PARTITIONS=1
      - KAFKA_CFG_DEFAULT_REPLICATION_FACTOR=1
      - KAFKA_CFG_LOG_RETENTION_HOURS=168
      - ALLOW_PLAINTEXT_LISTENER=yes
    ports:
      - "9092:9092"   # コンテナ間通信
      - "9094:9094"   # ホストからのアクセス（開発用）
    volumes:
      - kafka_data:/bitnami/kafka
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # Kafka トピック初期化（ワンショットコンテナ）
  kafka-init:
    image: bitnami/kafka:3.9
    container_name: eduanima_kafka_init
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ["/bin/bash", "-c"]
    command: >
      "
        echo '=== Creating Kafka topics ===' &&
        kafka-topics.sh --bootstrap-server kafka:9092
          --create --if-not-exists
          --topic eduanima.ingest.jobs
          --partitions 1
          --replication-factor 1 &&
        echo '=== Topics created ==='
      "
    restart: on-failure

  # ─────────────────────────────────────────
  # MinIO（Phase 1: GCS代替 S3互換オブジェクトストレージ）
  # Phase 2でGCS本番に切り替え時は professor の OBJECT_STORAGE_BACKEND=gcs に変更
  # ─────────────────────────────────────────
  minio:
    image: minio/minio:RELEASE.2025-01-20T22-07-31Z
    container_name: eduanima_minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Web Console（http://localhost:9001）
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # MinIO バケット初期化（ワンショットコンテナ）
  minio-init:
    image: minio/mc:latest
    container_name: eduanima_minio_init
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-eduanima-materials}
    entrypoint: >
      /bin/sh -c "
        mc alias set local http://minio:9000 $$MINIO_ROOT_USER $$MINIO_ROOT_PASSWORD &&
        mc mb --ignore-existing local/$$MINIO_BUCKET &&
        mc anonymous set none local/$$MINIO_BUCKET &&
        echo '=== MinIO bucket ready ==='
      "
    restart: on-failure

  # ─────────────────────────────────────────
  # eduanima-professor（Go バックエンド）
  # profile: app → docker compose --profile app up で起動
  # ─────────────────────────────────────────
  professor:
    profiles: ["app"]
    build:
      context: ./eduanimaR_Professor
      dockerfile: Dockerfile
      target: production
    container_name: eduanima_professor
    restart: unless-stopped
    ports:
      - "8080:8080"   # HTTP API（OpenAPI）
    environment:
      # Database
      DATABASE_URL: postgres://${POSTGRES_USER:-eduanima}:${POSTGRES_PASSWORD:-eduanima_password}@postgres:5432/${POSTGRES_DB:-eduanima_professor}?sslmode=disable
      # Kafka
      KAFKA_BROKERS: kafka:9092
      KAFKA_TOPIC_INGEST: eduanima.ingest.jobs
      # Object Storage（Phase 1: MinIO）
      OBJECT_STORAGE_BACKEND: minio
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-eduanima-materials}
      MINIO_USE_SSL: "false"
      # Librarian gRPC
      LIBRARIAN_GRPC_ADDR: librarian:50051
      # Gemini AI
      PROFESSOR_MODEL_FAST: ${PROFESSOR_MODEL_FAST:-gemini-2.0-flash}
      PROFESSOR_MODEL_ACCURATE: ${PROFESSOR_MODEL_ACCURATE:-gemini-2.5-pro}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      # Server
      PORT: "8080"
      LOG_LEVEL: ${LOG_LEVEL:-info}
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      minio:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
      minio-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ─────────────────────────────────────────
  # eduanima-librarian（Python 推論サービス）
  # profile: app → docker compose --profile app up で起動
  # ─────────────────────────────────────────
  librarian:
    profiles: ["app"]
    build:
      context: ./eduanimaR_Librarian
      dockerfile: Dockerfile
    container_name: eduanima_librarian
    restart: unless-stopped
    ports:
      - "50051:50051"   # gRPC サーバー
    environment:
      GRPC_PORT: "50051"
      LIBRARIAN_MODEL_FAST: ${LIBRARIAN_MODEL_FAST:-gemini-2.0-flash}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    healthcheck:
      test: ["CMD", "python", "-c", "import grpc; ch = grpc.insecure_channel('localhost:50051'); grpc.channel_ready_future(ch).result(timeout=5); print('ok')"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 20s

volumes:
  postgres_data:
    name: eduanima_postgres_data
  kafka_data:
    name: eduanima_kafka_data
  minio_data:
    name: eduanima_minio_data

networks:
  default:
    name: eduanima_network
