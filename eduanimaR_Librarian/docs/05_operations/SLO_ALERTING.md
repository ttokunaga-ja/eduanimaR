# SLO_ALERTING

## 目的
「何が壊れているか」を最短で判断できるように、SLO とアラートの最小標準を定義する。

## 用語
- **SLI**: 指標（例: 成功率、レイテンシ）
- **SLO**: 目標（例: 30日成功率 99.9%）
- **Error Budget**: 許容できる失敗の枠（SLO 未達の余地）

---

## SLO 設計（Must）

SLO は「運用の意思決定」に直結するため、以下をセットで固定する。

- 対象（ユーザー影響のある API / 非同期処理）
- 失敗判定（何を失敗とみなすか）
- 期間（例：7日 / 30日）
- 目標（SLO）
- 計測元（メトリクス名・ラベル粒度）

### テンプレ（プロジェクトで埋める）

| 対象 | SLI | 期間 | SLO | 失敗判定 | 備考 |
|---|---|---|---|---|---|
| Librarian API（HTTP） | 成功率 | 30日 | 99.9% | HTTP 5xx / timeout | ルート単位で分割 |
| Librarian API（HTTP） | p95 レイテンシ | 30日 | < X ms | N/A | ルート単位で分割 |
| 依存先（Professor） | 成功率 | 30日 | 99.9% | HTTP 5xx / timeout | outbound を別監視 |
| 依存先（Gemini） | 成功率 | 30日 | 99.9% | 5xx / timeout | quota/429 は別途方針化 |

## 最小SLO（テンプレ）
以下は例。実際の値はプロダクト要件（UX/収益/法令）で決める。

### 外部API（Gateway）
（本サービスでは Gateway 前提を置かない。呼び出し元は Professor を想定する。）

### Librarian API（HTTP）
- 成功率（HTTP 5xx / timeout を失敗）
- レイテンシ（p95/p99）

### 依存先（Professor / Gemini）
- 成功率/レイテンシ
- 依存障害が Librarian の 5xx に波及していないか

## アラート設計（推奨）
- **症状アラート**: ユーザー影響（成功率低下、遅延増大）
- **原因候補アラート**: 依存先（Professor / Gemini）の失敗率、接続枯渇、同時実行枯渇

### Burn-rate の考え方（概要）
- Error Budget の消費速度が速いときに通知する
- 速い窓（例: 5〜30分）と遅い窓（例: 6〜24時間）を組み合わせる

推奨（最低限の運用ルール）：
- ページャ対象は **症状アラートのみ** に絞る（原因候補は通知/チケット）
- “新規アラート追加” は Runbook とセットで行う（Runbook 無しのアラートは禁止）

## 最小Runbook（オンコール手順）
- 1) 影響範囲を確認（Gateway か特定サービスか）
- 2) 直近デプロイ/マイグレーション有無を確認
- 3) リクエスト相関（`request_id` / `trace_id`）でボトルネックを特定
- 4) 依存先（Professor / Gemini）の失敗率・レイテンシを確認
- 5) 一時緩和（レート制限強化、重い機能の切り離し、ロールバック）

## ダッシュボード最低要件
- サービス別: RPS、エラー率、p95/p99、サチュレーション（CPU/メモリ/コネクション）
- 依存先別: Professor / Gemini のレイテンシと失敗率

## 関連
- 05_operations/OBSERVABILITY.md
- 01_architecture/SYNC_STRATEGY.md
