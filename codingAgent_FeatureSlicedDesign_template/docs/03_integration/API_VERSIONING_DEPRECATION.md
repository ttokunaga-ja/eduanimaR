# API Versioning & Deprecation（Frontend運用）

このドキュメントは、バックエンドのAPI変更がフロントに与える影響を最小化するために、
**互換性・段階移行・廃止**の運用を固定します。

関連：
- 契約運用：`API_CONTRACT_WORKFLOW.md`

---

## 結論（Must）

- “破壊的変更” は **即時適用しない**（互換期間を設ける）
- フロントは **tolerant reader**（追加フィールド/未知enumを許容）
- 段階的リリース（Feature Flag 等）で移行を安全にする
- 廃止は「日付・影響・ロールバック手順」を含めて告知し、計測しながら進める

---

## 1) 互換性の分類

### 後方互換（基本OK）
- レスポンスに optional フィールド追加
- 新しいエンドポイント追加
- エラーコード追加（既存を壊さない形）

注意：enum の値追加は「フロントが switch exhaustive している」場合に破壊になる。
→ フロント側は default ハンドリングを必須にする（`ERROR_CODES.md` 参照）。

### 破壊的（原則NG。やるなら廃止手順）
- フィールド削除/必須化
- 型の変更（string→number 等）
- エンドポイント削除
- エラー形式の変更

---

## 2) 段階移行の基本パターン

### Pattern A: 並行提供（推奨）
- `v1` と `v2`（または旧/新）を並行で提供
- フロントは Feature Flag で徐々に `v2` へ

### Pattern B: レスポンス互換レイヤ
- BE側で旧形式も返す（互換層）
- フロントは“読み取り互換”を維持しつつ、内部を新へ寄せる

---

## 3) 廃止（Deprecation）手順（テンプレ）

廃止を入れるPR/Issueには最低限以下を書く：
- 何を廃止するか（endpoint/field/error）
- 代替は何か
- 互換期間（開始日/終了日）
- 影響範囲（ページ/機能）
- 監視指標（該当APIの呼び出し数、失敗率）
- ロールバック手順

---

## 4) フロント側の実装原則

- 生成クライアント（Orval）以外から叩かない
- DTO最小化（DALで UI に必要な形へ）
- 旧/新を混在させる期間は「入口（DAL）」で吸収する

関連：`../01_architecture/DATA_ACCESS_LAYER.md`
